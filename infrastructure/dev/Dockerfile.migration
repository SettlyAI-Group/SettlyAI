FROM mcr.microsoft.com/dotnet/sdk:8.0

# Install PostgreSQL client tools
RUN apt-get update && apt-get install -y postgresql-client && rm -rf /var/lib/apt/lists/*

# Install EF Core tools globally
RUN dotnet tool install --global dotnet-ef

# Add dotnet tools to PATH
ENV PATH="$PATH:/root/.dotnet/tools"

WORKDIR /app

# Copy solution and project files first for better caching
COPY backend.sln ./
COPY SettlyApi/SettlyApi.csproj ./SettlyApi/
COPY SettlyModels/SettlyModels.csproj ./SettlyModels/
COPY SettlyService/SettlyService.csproj ./SettlyService/
COPY ISettlyService/ISettlyService.csproj ./ISettlyService/
COPY SettlyDbManager/SettlyDbManager.csproj ./SettlyDbManager/
COPY SettlyApiTests/SettlyApiTests.csproj ./SettlyApiTests/

# Restore packages
RUN dotnet restore backend.sln

# Copy the rest of the source code
COPY . .

# The entrypoint script will be mounted as a volume, so we don't copy it here
# Instead, we'll reference it in the docker-compose.yml

# Default command - will be overridden by docker-compose
CMD ["sleep", "30"]